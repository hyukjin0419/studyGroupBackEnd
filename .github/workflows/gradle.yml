name: Deploy Syncmate to Lightsail

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    # 1) ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
    - name: Checkout code
      uses: actions/checkout@v4

    # 2) JDK ì„¤ì¹˜
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: 17
        distribution: temurin

    # 3) Gradle ìºì‹œ í™œì„±í™” (ğŸš€ ë¹Œë“œ ì†ë„ 2~3ë°° í–¥ìƒ)
    - name: Setup Gradle Cache
      uses: gradle/actions/setup-gradle@v4

    # 4) gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
    - name: Grant execute permission
      run: chmod +x ./gradlew

    # 5) ë¹Œë“œ ì‹¤í–‰ (-x test í¬í•¨ â† ë°°í¬ë§Œ í•  ê±°ë‹ˆê¹Œ)
    - name: Build Project
      run: ./gradlew build -x test

    # 6) jar íŒŒì¼ ì„œë²„ë¡œ ì—…ë¡œë“œ
    - name: Copy JAR to server
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        source: "build/libs/*.jar"
        target: "/home/ubuntu/syncmate"
        strip_components: 2

    # 7) ì„œë²„ì—ì„œ jar êµì²´ + systemd ì¬ì‹œì‘
    - name: Restart SyncMate Service
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          cd /home/ubuntu/syncmate
          JAR_FILE=$(ls *SNAPSHOT.jar | grep -v plain)
          mv $JAR_FILE syncmate.jar
          sudo systemctl daemon-reload
          sudo systemctl restart syncmate

